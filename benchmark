#!/bin/bash

# server that host VM
SERVER=m2000-server
# VM where tests are executed
# VM should be set with autologin
VM=fedora25

# function to run commands on server
ssh_server() {
	ssh root@$SERVER "$@"
}

# function to run commands on VM
ssh_vm() {
	cmd="$*"
	cmd="${cmd//\'/\'\\\'\'}"
	ssh_server ssh root@192.168.121.13 "'$cmd'"
}

error() {
	echo "$*" >&2
	exit 1
}

log() {
	echo "$*"
}

# make sure VM is started
if ! ssh_server virsh list | grep -q $VM; then
	log "Starting remove VM"
	ssh_server virsh start $VM
	sleep 3
fi

one_test() {
	# put all file in a new directory
	DIR="$(date +%Y%m%d%H%M%S)_log"
	mkdir -p $DIR
	cd $DIR

	# copy this script just to save the details
	cp ../benchmark .
	rpm -qa > rpm_qa.txt
	lspci -vv > lspci_vv.txt
	lspci -n > lspci_n.txt

	# set our parameters
	ssh_vm 'cat > /etc/sysconfig/spice-streaming-agent' << EOF
SPICE_STREAMING_EXTRA_ARGS=-l /tmp/streaming.log --no-log-frames $*
EOF

	log "Reboot VM"
	ssh_vm reboot
	sleep 30

	log "Prepare the test"
	ssh_vm 'cat > xx_test' << "EOF"
nvidia-smi stats > nvidia_stats.txt &
nvidia_pid=$!

XAUTHORITY=/run/user/1000/gdm/Xauthority DISPLAY=:0 glxgears -fullscreen &
pid=$!
sleep 3
kill $pid

kill $nvidia_pid
EOF

	log "Launch remote viewer"
	~/install/bin/remote-viewer spice://m2000-server:5900 &
	pid=$!
	sleep 1
	ssh_vm 'bash xx_test'
	kill $pid

	ssh_vm 'cat /tmp/streaming.log' > streaming.log
	ssh_vm 'cat nvidia_stats.txt' > nvidia_stats.txt

	cd ..
}

main() {
	for dwqp in 26 5 10 20 30 40 51; do
		for rates in constqp vbr cbr 2passq 2passf 2passi; do
			for profile in 77 66 100; do
				for frames in 30 20 10; do
					one_test -c framerate=$frames -c ratecontrol=$rates -c dwqp=$dwqp -c profile=$profile
				done
			done
		done
	done
	exit 0
}

main
