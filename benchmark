#!/usr/bin/env python3
import time
import importlib
import re
import yaml
import measurement
import database

# load configuration file
# TODO pass somehow to measurement. Global??
with open("benchmark.yaml", 'r') as f:
    cfg = yaml.safe_load(f)

# TODO pass configuration
database = database.Database()

# load and initialize measurements
measurements = []
name_re = re.compile(r'^[a-z_][a-z0-9_]*$', re.I)
for m in cfg['measurements']:
    cfg = None
    if type(m) == dict:
        l = list(m.keys())
        assert len(l) == 1, 'Invalid measurement specification %s' % m
        cfg = m[l[0]]
        m = l[0]
    if type(m) != str or not name_re.match(m):
        raise Exception('Invalid module name %s' % m)
    mod = importlib.import_module('measurement.' + m.lower())
    measurements.append(getattr(mod, m)(cfg=cfg))

for m in measurements:
    m.setup()
for m in measurements:
    m.start()

# TODO do something more useful!
time.sleep(5)

for m in measurements:
    m.stop()
for m in measurements:
    m.collect()

# TODO do some data management
# TODO save to database
