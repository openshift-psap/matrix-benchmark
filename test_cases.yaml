name: simple-test
description: shows 3D shapes in motion
before:
  - vm do killall firefox
  - vm open https://webglsamples.org/video/video.html
  - sleep 10

codec: gst.vp8.vaapivp8enc

run:
  test_framerate:
    _framerate: 15, 20, 25, 30, 35, 40, 45
    gst.prop=keyframe-max-dist: 5
    gst.prop=target-bitrate: 4000


record_time: 20

after:
  - vm do killall firefox
---
_type: matrix
name: matrix
record_time: 40
#codec: gst.h264.vaapih264enc
#codec: gst.h264.nvh264enc
codec: nv.plug.h264
#codec: gst.vp8.vaapivp8enc

scripted_properties:
  display:
    #gst_ball:
    img_lady_1920:
    vlc_wipeout:
    webgl_wipeout: https://phoboslab.org/wipeout/
    #webgl_aquarium: https://webglsamples.org/aquarium/aquarium.html
    webgl_cubemap: https://webglsamples.org/dynamic-cubemap/dynamic-cubemap.html
    #webgl_lots_of_objects: https://webglsamples.org/google-io/2011/lots-of-objects-google.html
    #webgl_sprites: https://webglsamples.org/sprites/index.html
  #resolution: 1920x1080

matrix:
  framerate: 200
  nv.ratecontrol: cbr
  nv.max-bitrate: 8, 16, 32, 64
  nv.gop: 0
  nv.blocking: 0

nvh264enc_matrix:
  gst.prop=bitrate: 8000, 16000, 32000, 64000
  gst.prop=gop-size:  -1 #30, 300, -1
  gst.prop=rc-mode: cbr

vaapi_matrix:
  gst.prop=bitrate: 8000, 16000, 32000, 64000
  gst.prop=rate-control: cbr
  gst.prop=keyframe-period: 30, 300, 600000

nvplug_matrix:
  nv.ratecontrol: cbr
  nv.max-bitrate: 8, 16, 32, 64
  nv.gop: 0
  nv.blocking: 0

scripts:
  setup:
    - vm resolution 1920x1080
    - xset s off -dpms
    - server exec xset s off -dpms
  teardown:
    - xset s on +dpms
    - server exec xset s on +dpms

  display:
    before:
      - vm display start $display
    after:
      - vm display stop $display

  resolution:
    before:
      - vm resolution $resolution
    after:
      - vm resolution 1920x1200

  resources:
    before:
      - /py/ stress_test $resources
    after:
      - /py/ stress_test normal
