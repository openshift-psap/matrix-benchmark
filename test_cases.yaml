name: simple-test
description: shows 3D shapes in motion
before:
  - vm do killall firefox
  - vm open https://webglsamples.org/video/video.html
  - sleep 10

codec: gst.vp8.vaapivp8enc

run:
  test_framerate:
    _framerate: 15, 20, 25, 30, 35, 40, 45
    gst.prop=keyframe-max-dist: 5
    gst.prop=target-bitrate: 4000


record_time: 40

after:
  - vm do killall firefox
---
_type: matrix
name: matrix
record_time: 40

script_config:
  display:
    webgl_wipeout: https://phoboslab.org/wipeout/
    webgl_cubemap: https://webglsamples.org/dynamic-cubemap/dynamic-cubemap.html
    web_still: https://news.ycombinator.com/

run:
  - _nv-plug, _vaapi, _current
  - _study-fps
  - #study_resolution
  - #study_bitrate
  - #study_kfr
  - study_display

expe:
  current:
    codec: gst.vp8.vaapivp8enc
    encoding:
      framerate: 20, 30, 40
      nv.ratecontrol: cbr
      nv.max-bitrate: 8, 16, 32
      nv.gop: 30, 300, 0
      nv.blocking: 0
    scripts:
      display: webgl_wipeout, img_lady_1920
      resolution: 1920x1080

  study_fps:
    codec: gst.vp8.vaapivp8enc
    encoding:
      framerate: 20, 25, 30, 35, 40, 45, 50
      gst.prop=bitrate: 8000, 16000, 32000
      gst.prop=keyframe-period: 128, 128
      gst.prop=rate-control: cbr
    scripts:
      display: webgl_wipeout, img_lady_1920
      resolution: 1920x1080, 1280x720

  study_resolution:
    codec: gst.vp8.vaapivp8enc
    encoding:
      framerate: 30, 40
      gst.prop=bitrate: 8000, 16000, 32000
      gst.prop=keyframe-period: 128
      gst.prop=rate-control: cbr
    scripts:
      display: webgl_wipeout, img_lady_1920
      resolution: 1600x1200, 1400x1050, 1280x960, 1024x768, 800x600, 640x480

  study_bitrate:
    codec: gst.vp8.vaapivp8enc
    encoding:
      framerate: 30
      gst.prop=bitrate: 2000, 4000, 8000, 12000, 16000, 24000, 32000, 48000, 64000
      gst.prop=keyframe-period: 128
      gst.prop=rate-control: cbr
    scripts:
      display: webgl_wipeout, img_lady_1920
      resolution: 1920x1080, 1280x720

  study_kfr:
    codec: gst.vp8.vaapivp8enc
    encoding:
      framerate: 30
      gst.prop=bitrate: 16000, 48000
      gst.prop=keyframe-period: 2, 4, 8, 16, 32, 64, 128, 256, 512, 1024, 9000
      gst.prop=rate-control: cbr
    scripts:
      display: webgl_wipeout, img_lady_1920
      resolution: 1920x1080

  study_display:
    codec: gst.vp8.vaapivp8enc
    encoding:
      framerate: 30, 40
      gst.prop=bitrate: 16000
      gst.prop=keyframe-period: 256
      gst.prop=rate-control: cbr
    scripts:
      display: webgl_wipeout, webgl_cubemap, img_lady_1920, img_lady_1280, web_still, vlc_wipeout, vlc_primordial, vlc_mix-quick, vlc_google_map
      resolution: 1920x1080

  gst.nvenc:
    codec: gst.h264.nvh264enc
    encoding:
      gst.prop=bitrate: 32000
      gst.prop=gop-size:  30, 300, -1
      gst.prop=rc-mode: cbr
      framerate: 20, 30, 40
    scripts:
      display: img_lady_1920, webgl_wipeout
      resolution: 1920x1080

  vaapi:
    codec: gst.vp8.vaapivp8enc
    encoding:
      framerate: 20, 30, 40
      gst.prop=bitrate: 8000, 16000, 32000
      gst.prop=rate-control: cbr
      gst.prop=keyframe-period: 128, 512
    scripts:
      display: img_lady_1920, webgl_wipeout
      resolution: 1920x1080

  nv-plug:
    codec: nv.plug.h264
    encoding:
      nv.ratecontrol: cbr
      nv.max-bitrate: 8, 16, 32, 64
      nv.gop: 0
      nv.blocking: 0
    scripts:
      display: img_lady_1920, webgl_wipeout
      resolution: 1920x1080

scripts:
  setup:
    - vm resolution 1920x1080
    - xset s off -dpms
    - atuona perf on

  teardown:
    - vm resolution 1920x1080
    - xset s on +dpms
    - server perf off

  display:
    before:
      - vm display start $display
    after:
      - vm display stop $display

  resolution:
    before:
      - vm resolution $resolution
    after:
      - vm resolution 1920x1200

  resources:
    before:
      - /py/ stress_test $resources
    after:
      - /py/ stress_test normal
