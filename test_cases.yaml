name: simple-test
description: shows 3D shapes in motion
before:
  - vm do killall firefox
  - vm open https://webglsamples.org/video/video.html
  - sleep 10

codec: gst.vp8.vaapivp8enc

run:
  test_framerate:
    _framerate: 15, 20, 25, 30, 35, 40, 45
    gst.prop=keyframe-max-dist: 5
    gst.prop=target-bitrate: 4000


record_time: 20

after:
  - vm do killall firefox
---
_type: matrix
name: matrix
record_time: 30
codec: gst.vp8.vaapivp8enc

scripted_properties:
  gst-videotestsrc: smpte, snow, ball
  resolution: 1920x1080, 1366x768, 848x480
  #resources: normal, vm:X*cpu, server:X*cpu, client:X*cpu, vm:X*cpu/client:X*cpu
  resources: normal, cpu:X*vm/cpu:X*client/net:10ms+2.5M

matrix:
  gst.prop=bitrate: 1000, 10000, 100000
  gst.prop=rate-control: vbr, cbr
  gst.prop=keyframe-period: 25, 60 #0, 20, 40
  framerate: 25, 35 #20, 30, 45, 60

scripts:
  setup:
    - xset s off -dpms
    - server exec xset s off -dpms
  teardown:
    - xset s on +dpms
    - server exec xset s on +dpms

  gst-videotestsrc:
    before:
      # https://gstreamer.freedesktop.org/documentation/videotestsrc/index.html
      - '[ "$gst-videotestsrc" != "nothing" ] && vm do gst-launch-1.0 -v videotestsrc pattern=$gst-videotestsrc ! video/x-raw,width=1920,height=1080 ! autovideosink >/dev/null &'
      - '[ "$gst-videotestsrc" != "nothing" ] && sleep 1'
      - '[ "$gst-videotestsrc" != "nothing" ] && vm do wmctrl -r ":ACTIVE:" -b toggle,fullscreen'
    after:
      - vm do pkill gst-launch-1.0

  resolution:
    before:
      - vm resolution $resolution
    after:
      - vm resolution 1200x1920

  resources:
    before:
      - /py/ stress_test $resources
    after:
      - /py/ stress_test normal
